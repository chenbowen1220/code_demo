/*
 * INCLUDE FILES
 **************************************************************************************************
 */
/* hal includes */

/* reg includes */

/* other includes */

/* self includes */
#include "fml_misc.h"

/*
 * MACRO DEFINES
 **************************************************************************************************
 */

/*
 * ENUM DEFINES
 **************************************************************************************************
 */

/*
 * STRUCTURE DEFINES
 **************************************************************************************************
 */

/*
 * LOCAL FUNCTION DECLARATIONS
 **************************************************************************************************
 */

/*
 * GLOBAL VARIABLE DEFINITIONS
 **************************************************************************************************
 */

/*
 * LOCAL VARIABLE DEFINITIONS
 **************************************************************************************************
 */

/*
 * LOCAL FUNCTION DEFINITIONS
 **************************************************************************************************
 */

/*
 * EXPORTED FUNCTION DEFINITIONS
 **************************************************************************************************
 */
void fml_misc_dsd_to_pcm(uint8_t *p_u8_dsd_data, uint16_t u16_dsd_size, int16_t *p_s16_pcm_out, uint16_t u16_pcm_size)
{
    uint32_t u32_dsd_accum = 0;
    int16_t s16_out = 0;

    for (int i = 0; i < u16_dsd_size && i < u16_pcm_size; i++) {
        for (int bit = 0; bit < 8; bit++) {
            u32_dsd_accum += (p_u8_dsd_data[i] & CO_BIT(bit)) ? 1 : -1;
        }

        s16_out = (int16_t)((u32_dsd_accum - 0x800000) >> 8);
        p_s16_pcm_out[i] = s16_out;
    }
}
